## Redis 캐시 전략

- 캐시는 메모리(RAM)을 사용해 일반적인 데이터베이스 보다 훨씬 빠르게 사용자에게 응답을 할 수 있어 일정 규모 이상의 애플리케이션에서는 필수적으로 사용되는 기술이다. 하지만 캐시는 데이터를 분산시켜두는 전략이기 때문에 기본적으로 데이터 정합성에 취약하고, 또한 어느 데이터를 얼마만큼, 얼마나 오랫동안 캐싱하느냐 하는 문제 등 고려할 사항이 생각보다 다양하다. 그중 Redis에서 활용할 수 있는 캐시 전략에는 어떤 것들이 있는지 알아보자.
- 캐시 설계시 고려할 사항들은 아래와 같이 구분할 수 있다.
  - 캐시 읽기 전략
  - 캐시 쓰기 전략
  - 캐시 저장 지침
  - 캐시 제거 지침
  - 캐시 공유 방식
- ### 캐시 읽기 전략
  - #### Look Aside 패턴
    - 캐시를 사용할 때 가장 일반적으로 사용되는 방식 
    - 데이터를 찾을 때 우선 캐시에 저장된 데이터가 있는지 확인하고 없으면 DB에서 찾는 방식
    - 반복적인 읽기가 많은 작업에 적합함
    - 단건 호출 빈도가 높은 서비스에는 부적합, 동일 쿼리 반복 서비스에 적합
    - 원하는 데이터만 별도로 구성하여 캐시에 저장
    - 캐시와 DB 분리로 캐시 장애 대비 구성이 되어 있음
    - 다만 redis 다운 시 순간적으로 DB에 커넥션이 몰려 부하가 발생할 가능성 있음
  - #### Read Through 패턴
    - 데이터를 찾을 때 우선 캐시에 저장된 데이터가 있는지 확인하고 없으면 DB에서 데이터를 가져와 캐시에 업데이트하여 제공하는 방식
    - 서버가 DB에 직접 접근하는 일이 없이 캐시를 통해서만 데이터를 조회한다.
    - 따라서 조회 속도는 느린편이지만, 항상 캐시와 DB 데이터간 정합성이 보장된다.
    - 캐시 서버 다운시 서비스 장애로 이어지기 때문에 Replication 또는 Clustering으로 대비하여야 한다.
  > 애플리케이션 최초 로딩 시에는 캐시가 하나도 없기 때문에 초기에 DB로 트래픽이 몰리는 현상이 있을 수 있다. 이럴 경우를 대비하여 Cache Warming이라는 작업을 해주는 것이 좋다. Cache Warming은 빈번한 읽기가 예상되는 데이터를 애플리케이션 로딩 시점에 캐시에 미리 적재해두는 기법을 의미한다.

- ### 캐시 쓰기 전략
  - #### Write back 패턴
    - 데이터를 저장할 때 DB에 바로 쿼리하지 않고, 캐시에 모아뒀다가 주기적으로 한번에 DB에 업데이트 하는 방식
    - DB로 업데이트 될 데이터가 캐시에 모여있어 DB와의 동기화 작업이 필요 없기 때문에 데이터 정합성이 보장된다.
    - Write가 빈번하면서 Read하는 데에 많은 리소스가 드는 서비스에 적합
    - 캐시 장애시 데이터가 한번에 유실될 수 있다는 단점이 있지만, DB장애시에도 데이터는 보존된다는 장점도 있음
  - #### Write Through 패턴
    - 데이터 저장시 캐시에 먼저 저장하고 이후 DB에 저장하는 방식
    - 캐시가 DB보다도 최신상태의 데이터를 유지하므로 데이터 정합성이 보장됨
    - 데이터를 유실하면 안 되는 상황에 사용
    - 매 요청마다 두번의 write가 발생하므로 빈번한 삽입 삭제가 발생하는 서비스에는 성능 저하가 있음
  > 두 패턴 모두 무조건 캐시에 저장하는 특성으로인해 조회 빈도가 거의 없는 데이터들도 저장되어 리소스의 낭비가 발생하기 때문에 TTL(expire)를 설정하여 적절한 시점에 데이터를 삭제해주어야 한다.
  - #### Write Around 패턴
    - 쓰기 작업시 캐시를 거치지 않고 바로 DB에 저장하는 방식으로 쓰기 속도가 가장 빠르다.
    - 조회시 Cache miss가 발생하면 DB에서 데이터를 가져와 캐시와 동기화 시킨다.
    - 데이터 정합성의 불일치가 일어날 수 있다.
    - 쓰기 작업이 잦고, 쓰기 데이터가 조회 빈도가 낮은 상황에 적합

- ### 캐시 저장 지침
  - 캐시에 저장하는 데이터는 **자주 조회되면서 자주 변경되지는 않는 데이터**를 저장하는 것이 좋다.
  - 캐시에 저장되는 데이터는 기본적으로 휘발성이므로 중요 정보, 민감 정보는 저장하지 않는 것이 좋다.
- ### 캐시 제거 지침
  - 캐시 데이터는 기본 만료 정책을 설정해야 한다.
  - 만료 주기가 너무 짧으면 데이터가 너무 빨리 제거돼 캐시 사용의 이점이 줄어든다.
  - 만료 주기가 너무 길면 메모리 부족현상이 발생하거나, 캐시 교체 알고리즘에 의해 자주 사용되는 데이터가 제거될 가능성도 생긴다.
- ### 캐시 공유 지침
  - 애플리케이션의 여러 인스턴스에서 캐시를 사용할 경우 데이터 정합성을 위해 동기화를 설정해주어야한다.
  - 캐시 데이터를 변경하기 직전에 데이터가 검색된 이후 변경되지 않았는지 모두 확인하는 방법이 있다. 이 방식은 업데이트가 드물고 충돌이 발생하지 않는 상황에 적용하기 좋다.
  - 캐시 데이터를 업데이트하기 전에 Lock을 거는 방식도 있다. 이 방식은 사이즈가 작아 업데이트가 빠르고 빈번하게 업데이트가 이루어 지는 서비스에 적합하다.
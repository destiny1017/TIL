## 프로세스 동기화

프로세스 동기화란 여러 프로세스가 동시에 같은 자원을 공유하며 실행될 때 자원의 일관성을 유지하는 기법을 의미한다.
여러 프로세스가 같은 자원을 공유하면 메모리를 효율적으로 사용할 수 있다는 장점이 있지만, 공유자원에 대한 삽입, 삭제, 수정 등의 작업이 일어나는 경우 각 프로세스들 간에 같은 자원을 서로 다르게 해석하는 문제(Race Condition)가 발생할 수 있으므로 동기화 작업은 필수라고 할 수 있다.
그리고 현대에는 프로세스간의 동기화 보다는 스레드간의 동기화가 더욱 활발하므로 스레드 동기화라고도 부른다.
  
### 경쟁 상태(Race Condition)
경쟁 상태란 여러 프로세스들이 동시에 공유 자원에 접근하는 상황에서, 어떤 순서로 접근하느냐에 따라 결과 값이 달라질 수 있는 상황을 의미한다. 즉, 프로세스들간의 데이터 불일치를 발생시킬 수 있는 상황으로서, 프로세스간의 실행 순서를 정해주는 동기화 매커니즘이 필요하다.  

경쟁 상태는 대표적으로 아래와 같은 세가지 상황에서 발생할 수 있다.  

#### 1. 커널 모드로 수행 중 인터럽트가 발생하는 경우
![img.png](../assets/race_condition_1.png)  
위와 같은 처리 흐름에서, 커널 모드에서의 작업은 count++로 값을 증가시켰다가, 작업이 끝난 후 다시 count--로 값을 감소시키며 초기상태로 되돌려 놓는 작업이지만, 커널 작업이 완료되기 전에 인터럽트가 발생하여 다른 프로세스에서 count에 접근하는 경우, 초기 값이 아닌 count++에 의해 증가된 값을 확인하게 되어 의도한 바와 다르게 데이터를 해석하게 된다.  
이러한 문제는 커널 모드의 수행이 끝나기 전에는 인터럽트를 받지 않도록 하는 방법(disable/enable)으로 문제를 해결할 수 있다.
  
#### 2. 프로세스가 커널 모드에서 작업중인 상태에서 Context Switch가 발생하는 경우
![img_1.png](../assets/race_condition_2.png)  
Pa 프로세스가 작업 중 시스템 콜을 통해 커널모드로 진입하여 작업을 처리하고 있었는데, 선점형 스케줄러에 의한 컨텍스트 스위치가 발생하여 Pb 프로세스로 CPU 제어 권한이 넘어갔다. 그리고 Pb에서도 시스템콜로 커널모드에 진입하게 되면, 아직 Pa의 작업이 완료되지 않은 상태의 데이터에 접근할 수 있게 된다.  
이는 커널 모드가 수행중일 때는 해당 프로세스가 선점되지 않도록 하고, 유저모드로 되돌아 오면 선점되게 함으로써 해결할 수 있다.
  
#### 3. 멀티 프로세서에서 공유 메모리 내의 커널 데이터에 접근하는 경우
![img_2.png](../assets/race_condition_3.png)  
멀티 프로세서 환경에서 여러 CPU가 동시에 커널의 자원에 접근하는 경우 발생할 수 있다. 이런 경우 커널자체에 lock을 걸면 처리 성능이 저하되므로, 각 프로세서가 접근 중인 데이터에 대해서만 lock을 거는 방식으로 해결할 수 있다.
  

### 임계 영역(Critical Section)
임계 영역이란 코드 상에서 race condigtion을 유발할 수 있는 부분을 의미한다. 즉, 공유 데이터를 접근하는 부분을 의미하는 것이다.
critical section에서 발생하는 race condtion문제를 예방하기 위해서는 아래와 같은 조건들을 만족해야 한다.
  
#### 1. 상호 배제(Mutual Exclusion)
- 이미 한 프로세스가 critical section에서 작업중이면 다른 프로세스는 critical section에 진입해서는 안 된다.
  
#### 2. 진행(Progress)
- Critical section에서 작업중인 프로세스가 없다면, critical section에 진입하고자 하는 프로세스가 있을 경우 진입할 수 있어야 한다.
  
#### 3. 한정 대기(Bound Waiting)
- 프로세스가 critical section의 진입을 요청한 후 다른 프로세스들이 이 프로세스보다 먼저 cirtical section에 진입하는 횟수의 제한이 있어야 한다. 즉, 프로세스가 critical section에 진입하기 위해 대기를 해선 안 된다는 뜻이다.
  
  
#### # 임계 영역 문제의 해결
그리고 이런 임계영역 해결 조건을 만족하는 알고리즘으로는, 피터슨 알고리즘이란 것을 사용한다. 이 알고리즘은 간단히 말해서 선양보 알고리즘이라고 할 수 있다. 임계영역에 진입하고싶은 프로세스는 먼저 임계영역에 진입하고 싶다고 선언을 한 후, 다른 프로세스도 진입하고 싶어하는 프로세스가 있는지 확인을 한다. 만일 그런 프로세스가 존재하면 그 프로세스가 먼저 진입할 수 있도록하고, 서로 양보 중이라면 먼저 선언한 프로세스가 진입하도록 하는 알고리즘이다.
  
```groovy
// Peterson's Algorithm
do { // 프로세스 i의 임계 영역
    
    // 프로세스 i가 임계 영역에 진입하고 싶다고 알리기 위한 플래그
    flag[i] = true;
    
    // 프로세스 j에게 turn(진입 순서)를 양보
    turn = j; // 1
    
    // j의 턴이 끝날때까지 반복문을 수행하며 기다림
    while (flag[j] && turn == j); // 2 busy waiting
    
    // j의 턴이 끝나면 반복문 종료 후 임계영역 진입
    cirtical section
    
    // 임계영역 작업 완료 후 flag를 되돌림
    flag[i]=false;
    
    remainder section

} while (true);
```  

